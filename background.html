<script>
//Map of all opened tabs keyed by tabId
var allOpenTabs = {};
// Map of recently closed tabs keyed by timestamp
var rcts = {};
//Array of RCT timestamps
var rctTimestamps = [];
//Maximum number of rcts shown on popup page
var maxPopupLength;
//Configuration of the extension
var extensionConfig;

//Gets all open windows.
chrome.tabs.getAllInWindow(null, function(tabs){
  for (var key in tabs) {
    allOpenTabs[tabs.id] = tabs[key];
  }
});

//Listener on update.
chrome.tabs.onUpdated.addListener(function(tabId, changeInfo, tab) {
  if (changeInfo.status == 'complete') {
    if (tab === undefined) return;
    allOpenTabs[tabId] = tab;
  }
});

//Listener on remove.
chrome.tabs.onRemoved.addListener(function(tabId) {
  var tabInfo = allOpenTabs[tabId];
  if (tabInfo == undefined) return;
  
  delete allOpenTabs[tabId];
  var timestamp = (new Date()).getTime();
  rcts[timestamp] = tabInfo;
  rctTimestamps.unshift(timestamp);
  
  storeRcts(rcts);
});

//Fetches the extension configuration
fetchExtensionConfig();

//Loads the values for the extension.
function loadValues() {
	// Fetches the maxPopupLength.
	fetchMaxPopupLength();
	// Fetches the recentlyClosedTabs.
	fetchRcts();
}

//Fetches the extension configuration
function fetchExtensionConfig() {
  var xhr = new XMLHttpRequest();
  xhr.open('GET', chrome.extension.getURL('manifest.json'), false);
  xhr.onreadystatechange = function() {
    if (this.readyState == 4) {
      extensionConfig = JSON.parse(this.responseText);
      var newVersion = (extensionConfig.version).split(/\./g);
      var storedVersion = localStorage['version'];
      if (storedVersion !== undefined) {
	      var oldVersion = (storedVersion).split(/\./g);
	      for (var i = 0; i < 2; i++) {
	        if ((newVersion[i] != oldVersion[i])) {
		        alert('Neue Version!');
	          //chrome.tabs.create( {'url' : chrome.extension.getURL('infonews.html'), 'selected' : true}, function(tab) {});
	          break;
	        }
	      }
	      if (extensionConfig.version != storedVersion) {
	        localStorage.setItem('version', extensionConfig.version);
	      }
      }
	  }
  };
  xhr.send();
}

//Fetches/Initialises the rcts from the localStorage.
function fetchRcts() {
  var rctsString = localStorage['recentlyClosedTabs'];
  if (rctsString === undefined) {
    storeRcts({});
  } else {
    rcts = JSON.parse(rctsString);
    rctTimestamps = [];
    for (var timestamp in rcts) rctTimestamps.unshift(timestamp);
  }
}

//Modifys/Persists the rcts to the localStorage.
//@param newRecentlyClosedTabs recentlyClosedTabs object to store in the localStorage
function storeRcts(newRcts) {
	if (newRcts !== undefined)
	  rcts = newRcts;
	localStorage.setItem('recentlyClosedTabs', JSON.stringify(rcts));
}

//Fetches/Initialises the maxPopupLength from the localStorage.
function fetchMaxPopupLength() {
  maxPopupLength = localStorage['maxPopupLength'];
  if (localStorage['maxPopupLength'] === undefined)
    storeMaxPopupLength(15);
}

// Modifys/Persists the maxPopupLength to the localStorage.
// @am newMaxPopupLength maxPopupLength to store in the localStorage
function storeMaxPopupLength(newMaxPopupLength) {
  maxPopupLength = newMaxPopupLength;
  localStorage.setItem('maxPopupLength', maxPopupLength);
}

//Adds a zero to the beginning of a number if it is a single letter number.
//@param number number to pad
//@return padded number with leading 0 if it is a single letter number
function pad2(number) {
  return (number < 10 ? '0' : '') + number;
}

var month = new Array(12);
month[0] = "January";
month[1] = "February";
month[2] = "March";
month[3] = "April";
month[4] = "May";
month[5] = "June";
month[6] = "July";
month[7] = "August";
month[8] = "September";
month[9] = "October";
month[10] = "November";
month[11] = "December";

var monthShort = new Array(12);
monthShort[0] = "Jan";
monthShort[1] = "Febr";
monthShort[2] = "Mar";
monthShort[3] = "Apr";
monthShort[4] = "May";
monthShort[5] = "Jun";
monthShort[6] = "Jul";
monthShort[7] = "Aug";
monthShort[8] = "Sep";
monthShort[9] = "Oct";
monthShort[10] = "Nov";
monthShort[11] = "Dec";

//Gets the date and time as string.
//@param timestamp id of the recently closed tabs element
//@return timeString if date == today, else dateString and timeString
function getDateString(timestamp) {
	var date = new Date();
	date.setTime(timestamp);
	var today = new Date();
	// German layout
	// var dateString = date.getDate() + ". " + monthShort[date.getMonth()];
	// English layout
	var dateString = monthShort[date.getMonth()] + " " + date.getDate();
	var timeString = pad2(date.getHours()) + ":" + pad2(date.getMinutes());
	if (date.getDate() == today.getDate() && date.getMonth() == today.getMonth() && date.getFullYear() == today.getFullYear()) {
		return timeString;
	} else {
		return dateString;
	}
}

//Gets the date and time as string.
//@param timestamp id of the recently closed tabs element
//@return timeString for the detailed date popup
function getDateStringDetail(timestamp) {
var date = new Date();
date.setTime(timestamp);
var dateString =  (date.getMonth() + 1) + "/" + date.getDate() + "/" + date.getFullYear();
var timeString = pad2(date.getHours()) + ":" + pad2(date.getMinutes());
return dateString  + " " + timeString;
}
 </script>